<script>
  /* ===== Drawer (menu latéral) ===== */
  (function(){
    var openBtn = document.getElementById('openDrawer');
    var closeBtn = document.getElementById('closeDrawer');
    var drawer  = document.getElementById('drawer');
    var backdrop= document.getElementById('backdrop');
    function open(){ drawer.classList.add('open'); backdrop.classList.add('show'); }
    function close(){ drawer.classList.remove('open'); backdrop.classList.remove('show'); }
    if(openBtn) openBtn.addEventListener('click', open);
    if(closeBtn) closeBtn.addEventListener('click', close);
    if(backdrop) backdrop.addEventListener('click', close);
    document.addEventListener('keydown', function(e){ if(e.key==='Escape') close(); });
  })();

  /* ===== Articles (avec IMG auto + lien de paiement optionnel) ===== */
  function autoImg(id){ return 'https://picsum.photos/seed/'+encodeURIComponent(id)+'/800/600'; }

  var ITEMS = [
    // Serrurerie
    {id:'vachette-a2p', name:'Cylindre de serrure Vachette A2P', brand:'Vachette', price:69.9, img:autoImg('vachette-a2p'), pay:'#', vendors:[
      {name:'Amazon', price:69.9, ship:'Gratuit', url:'#'},
      {name:'Leroy Merlin', price:72.5, ship:'4,90 €', url:'#'},
      {name:'Cdiscount', price:64.0, ship:'7,90 €', url:'#'}]},
    {id:'fichet-f3d', name:'Serrure de sécurité Fichet F3D', brand:'Fichet', price:289, img:autoImg('fichet-f3d'), pay:'#', vendors:[
      {name:'Amazon', price:289, ship:'Gratuit', url:'#'}, {name:'Bricomarché', price:299, ship:'9,90 €', url:'#'}]},
    {id:'bricard-mp', name:'Serrure multipoints Bricard', brand:'Bricard', price:189, img:autoImg('bricard-mp'), pay:'#', vendors:[
      {name:'Cdiscount', price:179, ship:'7,90 €', url:'#'}, {name:'Castorama', price:189, ship:'4,90 €', url:'#'}]},

    // Plomberie
    {id:'atlantic-200', name:'Chauffe-eau 200L Atlantic', brand:'Atlantic', price:429, img:autoImg('atlantic-200'), pay:'#', vendors:[
      {name:'ManoMano', price:429, ship:'29 €', url:'#'}]},
    {id:'thermor-150', name:'Chauffe-eau mural Thermor 150L', brand:'Thermor', price:379, img:autoImg('thermor-150'), pay:'#', vendors:[
      {name:'Leroy Merlin', price:379, ship:'29 €', url:'#'}]},
    {id:'ariston-100', name:'Chauffe-eau Ariston 100L', brand:'Ariston', price:319, img:autoImg('ariston-100'), pay:'#', vendors:[
      {name:'Amazon', price:319, ship:'Gratuit', url:'#'}]},
    {id:'grohe-mitigeur', name:'Mitigeur douche Grohe', brand:'Grohe', price:129, img:autoImg('grohe-mitigeur'), pay:'#', vendors:[
      {name:'Amazon', price:129, ship:'Gratuit', url:'#'}]},

    // PAC / Chauffage
    {id:'daikin-8kw', name:'Pompe à chaleur Daikin 8kW', brand:'Daikin', price:6990, img:autoImg('daikin-8kw'), pay:'#', vendors:[
      {name:'Proclim', price:6990, ship:'Sur devis', url:'#'}]},
    {id:'thermor-radiateur', name:'Radiateur électrique Thermor', brand:'Thermor', price:229, img:autoImg('thermor-radiateur'), pay:'#', vendors:[
      {name:'Castorama', price:229, ship:'9,90 €', url:'#'}]},

    // Menuiserie
    {id:'velux-ggl', name:'Fenêtre Velux GGL', brand:'Velux', price:499, img:autoImg('velux-ggl'), pay:'#', vendors:[
      {name:'Leroy Merlin', price:499, ship:'29 €', url:'#'}]},
    {id:'lapeyre-porte', name:'Porte intérieure Lapeyre', brand:'Lapeyre', price:199, img:autoImg('lapeyre-porte'), pay:'#', vendors:[
      {name:'Lapeyre', price:199, ship:'19 €', url:'#'}]},

    // Rénovation / Isolation
    {id:'toupret-enduit', name:'Enduit de rebouchage Toupret', brand:'Toupret', price:14.9, img:autoImg('toupret-enduit'), pay:'#', vendors:[
      {name:'Leroy Merlin', price:14.9, ship:'Retrait 2h', url:'#'}]},
    {id:'isover-lv200', name:'Laine de verre Isover 200mm', brand:'Isover', price:49, img:autoImg('isover-lv200'), pay:'#', vendors:[
      {name:'Point P', price:49, ship:'Sur devis', url:'#'}]},
    {id:'rockwool-120', name:'Laine de roche Rockwool 120mm', brand:'Rockwool', price:54, img:autoImg('rockwool-120'), pay:'#', vendors:[
      {name:'Gedimat', price:54, ship:'Sur devis', url:'#'}]},

    // Photovoltaïque
    {id:'sunpower-400', name:'Panneau SunPower 400W', brand:'SunPower', price:259, img:autoImg('sunpower-400'), pay:'#', vendors:[
      {name:'Prosolaire', price:259, ship:'29 €', url:'#'}]},
    {id:'qcells-425', name:'Panneau Qcells 425W', brand:'Qcells', price:239, img:autoImg('qcells-425'), pay:'#', vendors:[
      {name:'Prosolaire', price:239, ship:'29 €', url:'#'}]},

    // Déménagement
    {id:'cartons-10', name:'Lot 10 cartons de déménagement', brand:'CartonPro', price:24.9, img:autoImg('cartons-10'), pay:'#', vendors:[
      {name:'Amazon', price:24.9, ship:'Gratuit', url:'#'}]},
    {id:'diable-pliable', name:'Diable pliant 120kg', brand:'Tooli', price:59, img:autoImg('diable-pliable'), pay:'#', vendors:[
      {name:'Leroy Merlin', price:59, ship:'4,90 €', url:'#'}]},

    // Peinture / Carrelage
    {id:'dulux-10l', name:'Peinture murale Dulux Valentine 10L', brand:'Dulux', price:69, img:autoImg('dulux-10l'), pay:'#', vendors:[
      {name:'Bricomarché', price:69, ship:'9,90 €', url:'#'}]},
    {id:'marazzi-60', name:'Carrelage sol Marazzi 60x60', brand:'Marazzi', price:22, img:autoImg('marazzi-60'), pay:'#', vendors:[
      {name:'Castorama', price:22, ship:'Sur devis', url:'#'}]},

    // Électroménager
    {id:'samsung-ll', name:'Lave-linge Samsung 9kg', brand:'Samsung', price:429, img:autoImg('samsung-ll'), pay:'#', vendors:[
      {name:'Boulanger', price:429, ship:'Gratuit', url:'#'}]},
    {id:'whirlpool-lv', name:'Lave-vaisselle Whirlpool', brand:'Whirlpool', price:379, img:autoImg('whirlpool-lv'), pay:'#', vendors:[
      {name:'Darty', price:379, ship:'Gratuit', url:'#'}]},

    // Construction / Outillage
    {id:'lafarge-35', name:'Ciment Lafarge 35kg', brand:'Lafarge', price:9.9, img:autoImg('lafarge-35'), pay:'#', vendors:[
      {name:'Point P', price:9.9, ship:'Retrait', url:'#'}]},
    {id:'boschpro-18v', name:'Perceuse-visseuse Bosch Pro 18V', brand:'Bosch Pro', price:149, img:autoImg('boschpro-18v'), pay:'#', vendors:[
      {name:'Amazon', price:149, ship:'Gratuit', url:'#'}]},
    {id:'dewalt-190', name:'Scie circulaire DeWalt 190mm', brand:'DeWalt', price:139, img:autoImg('dewalt-190'), pay:'#', vendors:[
      {name:'ManoMano', price:139, ship:'6,90 €', url:'#'}]}
  ];

  /* ===== Catégorisation ===== */
  var RULES = [
    {cat:'Serrurerie', keys:['Vachette','Fichet','Bricard','Abus','cylindre','serrure']},
    {cat:'Plomberie', keys:['Atlantic','Thermor','Ariston','Grohe','Geberit','robinet','mitigeur','Chauffe-eau']},
    {cat:'Chauffage', keys:['chaudière','radiateur','chauffage','Thermor','De Dietrich','Vaillant']},
    {cat:'Pompe à chaleur', keys:['Daikin','Mitsubishi Electric','PAC','Pompe à chaleur']},
    {cat:'Menuiserie', keys:['Lapeyre','Velux','fenêtre','porte']},
    {cat:'Rénovation', keys:['Toupret','enduit','rebouchage']},
    {cat:'Isolation', keys:['Isover','Rockwool','laine','isolation']},
    {cat:'Panneaux photovoltaïques', keys:['SunPower','Qcells','photovoltaïque','solaire']},
    {cat:'Déménagement', keys:['carton','diable','déménagement']},
    {cat:'Peinture', keys:['Dulux','Ripolin','peinture']},
    {cat:'Carrelage', keys:['Marazzi','Porcelanosa','carrelage']},
    {cat:'Électroménager', keys:['Whirlpool','Samsung','Bosch Home','lave-linge','lave-vaisselle','réfrigérateur']},
    {cat:'Produits de construction', keys:['Lafarge','Semin','ciment','mortier','béton']},
    {cat:'Chantier / Outillage', keys:['Makita','DeWalt','Bosch Pro','outil','perceuse','scie','ponceuse']}
  ];

  function guessCategory(item){
    var hay = (item.name + ' ' + item.brand).toLowerCase();
    for (var i=0;i<RULES.length;i++){
      var rule = RULES[i];
      for (var j=0;j<rule.keys.length;j++){
        if (hay.indexOf(rule.keys[j].toLowerCase()) !== -1) return rule.cat;
      }
    }
    return 'Autres';
  }
  function euro(v){ return new Intl.NumberFormat('fr-FR',{style:'currency',currency:'EUR'}).format(v); }
  function findItem(id){ return ITEMS.find(function(x){return x.id===id}); }

  /* ===== Panier ===== */
  var CART_KEY='bati_dc_cart';
  function getCart(){ try{return JSON.parse(localStorage.getItem(CART_KEY)||'[]');}catch(e){return []} }
  function saveCart(c){ localStorage.setItem(CART_KEY, JSON.stringify(c)); renderCartIcon(); }
  function addToCart(id,qty){ qty=qty||1; var c=getCart(); var it=c.find(function(x){return x.id===id}); if(it) it.qty+=qty; else c.push({id:id,qty:qty}); saveCart(c); }
  function removeFromCart(id){ saveCart(getCart().filter(function(x){return x.id!==id})); renderCartPanel(); }
  function setQty(id,qty){ var c=getCart(); c.forEach(function(x){if(x.id===id)x.qty=Math.max(1,qty||1)}); saveCart(c); renderCartPanel(); }
  function renderCartIcon(){ var n=getCart().reduce(function(s,x){return s+x.qty},0),b=document.getElementById('cartCount'); if(!b)return; b.style.display=n>0?'inline-block':'none'; b.textContent=n>0?n:0; }

  /* ===== Fiche article ===== */
  var currentProductId=null;
  function openProduct(id){
    var item=findItem(id); if(!item) return; currentProductId=id;
    document.getElementById('poTitle').textContent=item.name;
    document.getElementById('poBrand').textContent=item.brand;
    var box=document.getElementById('poVendors'); box.innerHTML='';
    item.vendors.forEach(function(v){
      var row=document.createElement('div');
      row.style.cssText='display:flex;justify-content:space-between;align-items:center;padding:12px 14px;border-top:1px solid #eee;background:#fff';
      row.innerHTML='<div><strong>'+v.name+'</strong><div style="color:#6b7280">'+(v.ship||'')+'</div></div>'
        +'<div style="display:flex;gap:8px;align-items:center">'
        +'<div style="font-weight:800">'+euro(v.price)+'</div>'
        +'<a href="'+(v.url||'#')+'" target="_blank" style="border:2px solid #111;border-radius:10px;padding:6px 10px;text-decoration:none;color:#111;background:#fff">Voir</a>'
        +'</div>';
      box.appendChild(row);
    });
    document.getElementById('productOverlay').style.display='block';
  }
  function closeProduct(){ document.getElementById('productOverlay').style.display='none'; }
  document.getElementById('poClose').addEventListener('click',closeProduct);
  document.getElementById('poAdd').addEventListener('click',function(){ if(currentProductId){ addToCart(currentProductId,1); closeProduct(); openCart(); }});
  document.getElementById('poBuy').addEventListener('click',function(){
    if(!currentProductId) return; var item=findItem(currentProductId);
    if(item && item.pay && item.pay!=='#'){ window.location.href=item.pay; }
    else { addToCart(currentProductId,1); closeProduct(); openCart(); alert('Pas de lien de paiement défini pour cet article.'); }
  });

  /* ===== Rendu catalogue (avec IMG) ===== */
  (function render(){
    var groups={};
    for(var i=0;i<ITEMS.length;i++){ var it=ITEMS[i],cat=guessCategory(it); if(!groups[cat])groups[cat]=[]; groups[cat].push(it); }
    var order=[]; for(var r=0;r<RULES.length;r++) order.push(RULES[r].cat); for(var c in groups){ if(order.indexOf(c)===-1) order.push(c); }

    var wrap=document.getElementById('catalogue'); if(!wrap) return; wrap.innerHTML='';
    for(var k=0;k<order.length;k++){
      var cat=order[k],arr=groups[cat]; if(!arr) continue;
      var h=document.createElement('h2'); h.className='category'; h.textContent=cat; wrap.appendChild(h);

      var grid=document.createElement('div'); grid.className='grid';
      arr.forEach(function(o){
        var el=document.createElement('article'); el.className='card';
        var img = o.img || autoImg(o.id);
        el.innerHTML =
          '<img class="thumb" src="'+img+'" alt="'+o.name+'">' +
          '<div class="body">' +
            '<h3 class="title">'+o.name+'</h3>' +
            '<div class="sub">'+o.brand+'</div>' +
            '<div class="price">à partir de <strong>'+euro(o.price)+'</strong></div>' +
            '<div class="actions">' +
              '<button class="pill primary" data-id="'+o.id+'">Voir les prix</button>' +
              '<button class="pill dark" data-add="'+o.id+'">Ajouter au devis</button>' +
            '</div>' +
          '</div>';
        grid.appendChild(el);
      });
      wrap.appendChild(grid);
    }
    // actions cartes
    wrap.addEventListener('click',function(e){
      var id=e.target.getAttribute('data-id');
      var add=e.target.getAttribute('data-add');
      if(id) openProduct(id);
      if(add){ addToCart(add,1); openCart(); }
    });
  })();

  /* ===== Panier (tiroir droit) ===== */
  var cartBtn=document.getElementById('cartBtn');
  var cartPanel=document.getElementById('cartDrawer');
  var cartClose=document.getElementById('cartClose');
  function openCart(){ cartPanel.style.translate='0 0'; renderCartPanel(); }
  function closeCart(){ cartPanel.style.translate='100% 0'; }
  if(cartBtn) cartBtn.addEventListener('click',openCart);
  if(cartClose) cartClose.addEventListener('click',closeCart);

  function renderCartPanel(){
    var area=document.getElementById('cartItems'); if(!area) return;
    var cart=getCart(); if(cart.length===0){ area.innerHTML='<div style="color:#9ca3af">Votre panier est vide.</div>'; document.getElementById('cartTotal').textContent='0,00 €'; renderCartIcon(); return; }
    var total=0; area.innerHTML='';
    cart.forEach(function(l){
      var it=findItem(l.id); if(!it) return; var lineTotal=it.price*l.qty; total+=lineTotal;
      var line=document.createElement('div'); line.style.cssText='display:grid;grid-template-columns:1fr auto;gap:8px;align-items:center;padding:10px;border-bottom:1px solid #1f2937';
      line.innerHTML='<div><div style="font-weight:700">'+it.name+'</div><div style="color:#9ca3af">'+it.brand+'</div></div>'
        +'<div style="display:flex;gap:6px;align-items:center">'
        +'<button data-dec="'+it.id+'" style="border:1px solid #374151;background:#111827;color:#fff;border-radius:6px;padding:2px 8px">-</button>'
        +'<span>'+l.qty+'</span>'
        +'<button data-inc="'+it.id+'" style="border:1px solid #374151;background:#111827;color:#fff;border-radius:6px;padding:2px 8px">+</button>'
        +'<strong style="width:80px;text-align:right;display:inline-block">'+euro(lineTotal)+'</strong>'
        +'<button data-del="'+it.id+'" title="Supprimer" style="border:1px solid #ef4444;background:#7f1d1d;color:#fff;border-radius:6px;padding:2px 8px;margin-left:6px">✕</button>'
        +'</div>';
      area.appendChild(line);
    });
    document.getElementById('cartTotal').textContent=euro(total);
    renderCartIcon();
    area.onclick=function(e){
      var id;
      if(id=e.target.getAttribute('data-inc')) setQty(id,(getCart().find(function(x){return x.id===id})||{qty:0}).qty+1);
      if(id=e.target.getAttribute('data-dec')) setQty(id,(getCart().find(function(x){return x.id===id})||{qty:1}).qty-1);
      if(id=e.target.getAttribute('data-del')) removeFromCart(id);
    };
  }
  document.getElementById('checkoutBtn').addEventListener('click',function(){
    alert('Astuce : mets un lien Stripe dans "pay" pour un vrai paiement.');
  });

  // init
  renderCartIcon();
</script>
